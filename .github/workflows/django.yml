name: Django CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # --- CORE TESTING ---
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sample_user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: login_task_test
        ports: [5432:5432]
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Setup test environment
      run: |
        # Create minimal test settings
        echo "SECRET_KEY = 'test-key-${{ github.run_id }}'" > loginTask/local_settings.py
        echo "DEBUG = False" >> loginTask/local_settings.py
    
    - name: Run tests
      run: |
        python manage.py test --verbosity=2
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4  # CHANGED: v3 → v4
      with:
        name: test-results
        path: |
          test-results/
          coverage.xml
        retention-days: 7

  # --- LINTING ---
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"
      - name: Install linting tools
        run: pip install flake8 black
      - name: Run linting
        run: flake8 .  # MOVED: This was floating at the end

  # --- SIMPLE DEPLOYMENT ---
  deploy-staging:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to staging
      env:
        STAGING_SERVER: ${{ secrets.STAGING_SERVER }}
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        # Simple SSH deployment
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        ssh -o StrictHostKeyChecking=no deploy@$STAGING_SERVER "
          cd /var/www/login-task &&
          git pull origin main &&
          pip install -r requirements.txt &&
          python manage.py migrate &&
          sudo systemctl restart gunicorn
        "
    
    - name: Health check
      run: |
        sleep 10
        curl -f ${{ secrets.STAGING_URL }}/health/ || echo "Health check warning"

  # --- NOTIFICATIONS (Optional) ---
  notify:
    runs-on: ubuntu-latest
    needs: [test, deploy-staging]
    if: always()
    
    steps:
    - name: Status summary
      run: |
        echo "Pipeline status:"
        echo "- Tests: ${{ needs.test.result }}"
        echo "- Deployment: ${{ needs.deploy-staging.result }}"
        
        if [[ "${{ needs.test.result }}" == "success" ]]; then
          echo "✅ All tests passed"
        else
          echo "❌ Tests failed"
        fi
          echo "❌ Tests failed"
        fi
          flake8 .
